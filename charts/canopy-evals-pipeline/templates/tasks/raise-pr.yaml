---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: raise-pr
spec:
  workspaces:
    - name: output
  params:
    - name: WORK_DIRECTORY
      description: Directory to start build in (handle multiple branches)
      type: string
  steps:
    - name: patch-vector-db-id
      workingDir: $(workspaces.output.path)/$(params.WORK_DIRECTORY)
      image: quay.io/redhat-cop/ubi8-git:latest
      script: |
        #!/bin/sh

        git config --global user.email "tekton@mlops.bot.com"
        git config --global user.name "üêà Tekton üêà"
        git config --global push.default simple
        git config --global --add safe.directory '*'
        branch_name=genaiops_$(date +%Y_%m_%d_%H_%M)
        git checkout -b $branch_name
        cp values-test.yaml values-prod.yaml
        git add values-prod.yaml
        git commit -m "üöÄ AUTOMATED COMMIT - Production prompt is updated" || rc=$?
        git remote set-url origin $(cat $HOME/.git-credentials)/{{ .Values.USER_NAME }}/canopy-be.git
        git push origin $branch_name
        curl --location 'https://gitea-gitea.{{ .Values.CLUSTER_DOMAIN }}/api/v1/repos/{{ .Values.USER_NAME }}/canopy-be/pulls' --user 'opentlc-mgr:myPassw0rd' --header 'accept: application/json' --header 'Content-Type: application/json' \
          --data '{
              "assignee": "{{ .Values.USER_NAME }}",
              "base": "main",
              "body": "Evaluation results can be found in [Prompt Tracker](https://prompt-tracker-ai501.{{ .Values.CLUSTER_DOMAIN }}/{{ .Values.USER_NAME }}/{{ .Values.CLUSTER_DOMAIN }}).",
              "head": "'${branch_name}'",
              "title": "üöÄ AUTOMATED PR - Production prompts updates üöÄ"
          }'

          echo "‚òòÔ∏è A pull request is raised for prod: https://gitea-gitea.{{ .Values.CLUSTER_DOMAIN }}/{{ .Values.USER_NAME }}/canopy-be/pulls/"
  