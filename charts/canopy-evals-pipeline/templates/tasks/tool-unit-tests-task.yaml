apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: tool-unit-tests-task
spec:
  description: "Run pytest unit tests for agent tools (LangChain and MCP)"
  workspaces:
    - name: output
      description: Workspace for test files
  steps:
    - name: run-unit-tests
      image: registry.redhat.io/ubi9/python-311:latest
      workingDir: $(workspaces.output.path)/backend/main
      script: |
        #!/bin/bash
        set -e

        echo "Checking directory structure..."
        pwd
        ls -la

        echo "Installing test dependencies..."
        pip install -r main/requirements.txt
        pip install -r tests/requirements-test.txt

        echo "Running pytest unit tests for agent tools..."
        cd tests
        pytest -v test_tools.py

        echo "All unit tests passed successfully!"
      env:
        - name: CANOPY_CONFIG_PATH
          value: /canopy/canopy-config.yaml
      volumeMounts:
        - name: canopy-config
          mountPath: /canopy
          readOnly: true
  volumes:
    - name: canopy-config
      configMap:
        name: canopy-config