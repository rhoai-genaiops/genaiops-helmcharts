---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-test-values-task
spec:
  workspaces:
    - name: output
  params:
    - name: WORK_DIRECTORY
      description: Directory to start build in (handle multiple branches)
      type: string
    - name: USERNAME
      description: Name of the team that doing this exercise :)
      type: string
    - name: VECTOR_DB_ID
      description: Vector DB ID used in the pipeline
      type: string
  steps:
    - name: patch-vector-db-id
      workingDir: $(workspaces.output.path)/$(params.WORK_DIRECTORY)
      image: quay.io/redhat-cop/tekton-task-helm:3.6.3
      script: |
        #!/bin/sh

        vector_db_ids_file=$(params.VECTOR_DB_ID)

        test_vector_db_id=$(cat "${vector_db_ids_file}" | jq -r '.test_vector_db_ids')
        prod_vector_db_id=$(cat "${vector_db_ids_file}" | jq -r '.prod_vector_db_ids')

        echo "Test Vector DB ID: ${test_vector_db_id}"
        echo "Prod Vector DB ID: ${prod_vector_db_id}"

        # Update test values with test ID
        yq eval -i .information-search.vector_db_id=\"${test_vector_db_id}\" values-test.yaml

        # Update prod values with prod ID (assuming you have a values-prod.yaml)
        yq eval -i .information-search.vector_db_id=\"${prod_vector_db_id}\" values-prod.yaml

    - name: commit-changes
      workingDir: $(workspaces.output.path)/$(params.WORK_DIRECTORY)
      image: quay.io/redhat-cop/ubi8-git:latest
      script: |
        #!/bin/sh
        # Commit the changes :P
        git config --global user.email "tekton@mlops.bot.com"
        git config --global user.name "üêà Tekton üêà"
        git config --global push.default simple
        git config --global --add safe.directory '*'
        git add values-test.yaml
        git commit -m "üöÄ AUTOMATED COMMIT - Vector DB ID has updated üöÄ" || rc=$?
        git remote set-url origin $(cat $HOME/.git-credentials)/$(params.USERNAME)/backend.git
        git push origin HEAD:main
