FROM registry.access.redhat.com/ubi9/ubi-minimal:latest

RUN microdnf install -y nginx && microdnf clean all

COPY index.html /usr/share/nginx/html/

# Create custom nginx config for non-root on port 8080
# Use /tmp for all writable paths
RUN printf '%s\n' \
    'worker_processes auto;' \
    'error_log /dev/stderr;' \
    'pid /tmp/nginx.pid;' \
    'events { worker_connections 1024; }' \
    'http {' \
    '    client_body_temp_path /tmp/client_body;' \
    '    proxy_temp_path /tmp/proxy_temp;' \
    '    fastcgi_temp_path /tmp/fastcgi_temp;' \
    '    uwsgi_temp_path /tmp/uwsgi_temp;' \
    '    scgi_temp_path /tmp/scgi_temp;' \
    '    access_log /dev/stdout;' \
    '    include /etc/nginx/mime.types;' \
    '    default_type application/octet-stream;' \
    '    sendfile on;' \
    '    keepalive_timeout 65;' \
    '    server {' \
    '        listen 8080;' \
    '        server_name localhost;' \
    '        root /usr/share/nginx/html;' \
    '        index index.html;' \
    '        location / { try_files $uri $uri/ =404; }' \
    '    }' \
    '}' > /etc/nginx/nginx.conf && \
    chown -R nginx:nginx /usr/share/nginx/html && \
    touch /var/log/nginx/error.log && \
    chown nginx:nginx /var/log/nginx/error.log

USER nginx
EXPOSE 8080
CMD ["nginx", "-e", "/dev/stderr", "-g", "daemon off;"]
